{% extends 'base_hms.html' %}
{% load static %}

{% block title %}Audiometr√≠a - {{ ficha.nombre_trabajador }}{% endblock %}

{% block extra_css %}
<style>
    .audiometry-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        margin-bottom: 0;
    }

    .audio-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, #f8f9fc 0%, #eef2f7 100%);
        padding: 15px 20px;
        border-bottom: 1px solid #e3e6f0;
        font-weight: 600;
        color: #5a5c69;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-content {
        padding: 20px;
    }

    .basic-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-field {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #17a2b8;
    }

    .info-field label {
        font-weight: 600;
        color: #5a5c69;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
        display: block;
    }

    .info-field input,
    .info-field select,
    .info-field textarea {
        border: none;
        background: transparent;
        font-weight: 500;
        color: #2c3e50;
        width: 100%;
        padding: 5px 0;
        font-size: 0.9rem;
    }

    .antecedentes-laborales-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }

    .antecedentes-laborales-table th {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .antecedentes-laborales-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #e3e6f0;
        text-align: center;
        vertical-align: middle;
    }

    .antecedentes-laborales-table input,
    .antecedentes-laborales-table select {
        border: 1px solid #e3e6f0;
        border-radius: 4px;
        padding: 6px 8px;
        width: 100%;
        font-size: 0.85rem;
    }

    .antecedentes-auditivos-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .antecedentes-column {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
    }

    .antecedentes-column h6 {
        color: #17a2b8;
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
        border-bottom: 2px solid #17a2b8;
        padding-bottom: 8px;
    }

    .antecedente-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e3e6f0;
    }

    .antecedente-row:last-child {
        border-bottom: none;
    }

    .antecedente-row label {
        font-weight: 600;
        color: #5a5c69;
        margin: 0;
        flex: 1;
    }

    .antecedente-row input {
        flex: 1;
        margin-left: 10px;
        border: 1px solid #e3e6f0;
        border-radius: 4px;
        padding: 5px 8px;
    }

    .audiometry-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        font-size: 0.9rem;
    }

    .audiometry-table th {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .audiometry-table td {
        padding: 8px;
        border-bottom: 1px solid #e3e6f0;
        text-align: center;
        vertical-align: middle;
    }

    .audiometry-table .frequency-header {
        background: #17a2b8;
        color: white;
        font-weight: 600;
    }

    .audiometry-table .test-label {
        background: #f8f9fa;
        font-weight: 600;
        color: #5a5c69;
        text-align: left;
        padding-left: 15px;
    }

    .audiometry-table input {
        border: 1px solid #e3e6f0;
        border-radius: 4px;
        padding: 4px 6px;
        width: 50px;
        text-align: center;
        font-size: 0.8rem;
    }

    .tab-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        overflow: hidden;
    }

    .tab-headers {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #e3e6f0;
    }

    .tab-header {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        color: #5a5c69;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .tab-header.active {
        background: white;
        color: #17a2b8;
        border-bottom-color: #17a2b8;
    }

    .tab-content {
        padding: 20px;
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .caohc-severity {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .severity-column {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
    }

    .severity-column h6 {
        text-align: center;
        color: #17a2b8;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .severity-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e3e6f0;
    }

    .severity-item:last-child {
        border-bottom: none;
    }

    .severity-item input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
    }

    .severity-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .recommendation-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #17a2b8;
    }

    .recommendation-item input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
    }

    .recommendation-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .conventions-section {
        background: #e9ecef;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
    }

    .conventions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .convention-item {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        color: #495057;
    }

    .convention-symbol {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 2px solid;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .symbol-circle {
        border-color: #dc3545;
        color: #dc3545;
    }

    .symbol-x {
        border-color: #007bff;
        color: #007bff;
    }

    .symbol-bracket {
        border-color: #28a745;
        color: #28a745;
    }

    .symbol-arrow {
        border-color: #ffc107;
        color: #ffc107;
    }

    .symbol-square {
        border-color: #6f42c1;
        color: #6f42c1;
    }

    .otoscopy-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .otoscopy-field {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #17a2b8;
    }

    .otoscopy-field h6 {
        color: #17a2b8;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .otoscopy-field textarea {
        width: 100%;
        border: 1px solid #e3e6f0;
        border-radius: 4px;
        padding: 8px;
        resize: vertical;
        min-height: 80px;
    }

    .save-section {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 20px;
        border-top: 1px solid #e3e6f0;
        text-align: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .btn-save {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        transition: all 0.3s ease;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
    }

    .worker-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: bold;
        margin-right: 20px;
    }

    .header-info {
        display: flex;
        align-items: center;
    }

    .worker-details h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .worker-details p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }

    .instructivo-alert {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 10px 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

    .instructivo-alert i {
        color: #1976d2;
        margin-right: 10px;
    }

    .instructivo-alert a {
        color: #1976d2;
        text-decoration: none;
        font-weight: 500;
    }

    .prueba-conditions {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
    }

    .conditions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .condition-field {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .condition-field label {
        font-weight: 600;
        color: #2e7d32;
        margin: 0;
    }

    .btn-group-toggle {
        display: flex;
        gap: 5px;
    }

    .btn-toggle {
        padding: 5px 15px;
        border: 1px solid #17a2b8;
        background: white;
        color: #17a2b8;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-toggle.active {
        background: #17a2b8;
        color: white;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admision_recepcion:dashboard' %}">Admisi√≥n - Recepci√≥n</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admision_recepcion:fichas_clinicas' %}">Fichas Cl√≠nicas</a></li>
        <li class="breadcrumb-item active" aria-current="page">Audiometr√≠a</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de audiometr√≠a -->
    <div class="audiometry-header">
        <div class="header-info">
            <div class="worker-avatar">
                üîä
            </div>
            <div class="worker-details">
                <h3>Audiometr√≠a - {{ ficha.nombre_trabajador }}</h3>
                <p><strong>Ficha N¬∞:</strong> {{ ficha.numero_ficha }} | <strong>Identificaci√≥n:</strong> {{
                    ficha.numero_identificacion }}</p>
                <p><strong>Empresa:</strong> {% if ficha.empresa %}{{ ficha.empresa.razon_social }}{% else %}No
                    especificada{% endif %}</p>
            </div>
        </div>
    </div>

    <!-- Instructivo -->
    <div class="instructivo-alert">
        <i class="fas fa-info-circle"></i>
        <span>üëâüèº <a href="#" onclick="alert('Instructivo de Audiometr√≠a - En desarrollo')">De clic aqu√≠ para aprender
                o ver los instructivos</a></span>
    </div>

    <form method="post" id="audiometriaForm">
        {% csrf_token %}

        <!-- Informaci√≥n B√°sica del Examen -->
        <div class="audio-section">
            <div class="section-header">
                <span>üîä Informaci√≥n B√°sica de la Audiometr√≠a</span>
            </div>
            <div class="section-content">
                <div class="basic-info-grid">
                    <div class="info-field">
                        <label>Producto:</label>
                        <input type="text" name="producto" value="{{ audiometria.producto|default:'' }}">
                    </div>
                    <div class="info-field">
                        <label>Municipio:</label>
                        <input type="text" value="EL BANCO (MAGDALENA, COLOMBIA)" readonly>
                    </div>
                    <div class="info-field">
                        <label>Fecha:</label>
                        <input type="date" name="fecha_evaluacion" value="{{ ficha.fecha_evaluacion|date:'Y-m-d' }}"
                            required>
                    </div>
                    <div class="info-field">
                        <label>Tipo Evaluaci√≥n M√©dica:</label>
                        <select name="tipo_evaluacion_medica">
                            <option value="PREOCUPACIONAL">Pre-ocupacional</option>
                            <option value="OCUPACIONAL">Ocupacional</option>
                            <option value="POSTOCUPACIONAL">Post-ocupacional</option>
                        </select>
                    </div>
                    <div class="info-field">
                        <label>Empresa:</label>
                        <select name="empresa">
                            <option value="">Seleccione</option>
                            {% for empresa in empresas %}
                            <option value="{{ empresa.id }}" {% if ficha.empresa_id==empresa.id %}selected{% endif %}>
                                {{ empresa.razon_social }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-field">
                        <label>Tipo:</label>
                        <select name="tipo_documento">
                            {% for codigo, nombre in ficha.TIPO_DOC_CHOICES %}
                            <option value="{{ codigo }}" {% if ficha.tipo_documento==codigo %}selected{% endif %}>{{
                                nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-field">
                        <label>N√∫mero Identificaci√≥n:</label>
                        <input type="text" name="numero_identificacion" value="{{ ficha.numero_identificacion }}"
                            required>
                    </div>
                    <div class="info-field">
                        <label>Nombre:</label>
                        <input type="text" name="nombre_trabajador" value="{{ ficha.nombre_trabajador }}" required>
                    </div>
                    <div class="info-field">
                        <label>Edad:</label>
                        <input type="number" name="edad" value="{{ ficha.edad }}" min="16" max="100">
                    </div>
                    <div class="info-field">
                        <label>Cargo:</label>
                        <input type="text" name="cargo" value="{{ ficha.cargo }}">
                    </div>
                    <div class="info-field">
                        <label>Funciones del Cargo:</label>
                        <textarea name="funciones_cargo"
                            rows="3">{{ audiometria.funciones_cargo|default:'' }}</textarea>
                    </div>
                    <div class="info-field">
                        <label>EPS:</label>
                        <input type="text" name="eps" value="{{ audiometria.eps|default:'' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sistema de Tabs -->
        <div class="tab-container">
            <div class="tab-headers">
                <div class="tab-header active" onclick="showTab('antecedentes')">Historia de antecedentes</div>
                <div class="tab-header" onclick="showTab('evaluacion')">Evaluaci√≥n</div>
                <div class="tab-header" onclick="showTab('recomendaciones')">Recomendaciones</div>
            </div>

            <!-- Tab de Antecedentes -->
            <div id="antecedentes" class="tab-content active">
                <!-- Antecedentes Auditivos Laborales -->
                <h5>ANTECEDENTES AUDITIVOS LABORALES</h5>
                <table class="antecedentes-laborales-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>Cargo</th>
                            <th>Tipo de protecci√≥n</th>
                            <th>Tolerancia Elemento Protecci√≥n</th>
                            <th>Tiempo Exposici√≥n<br>A√±os</th>
                            <th>Meses</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for antecedente in antecedentes_laborales %}
                        <tr>
                            <td><input type="text" value="{{ antecedente.empresa }}" readonly></td>
                            <td><input type="text" value="{{ antecedente.cargo }}" readonly></td>
                            <td>
                                <select disabled>
                                    {% for codigo, nombre in tipo_proteccion_choices %}
                                    <option value="{{ codigo }}" {% if antecedente.tipo_proteccion==codigo %}selected{%
                                        endif %}>{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select disabled>
                                    {% for codigo, nombre in tolerancia_choices %}
                                    <option value="{{ codigo }}" {% if antecedente.tolerancia_proteccion==codigo
                                        %}selected{% endif %}>{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" value="{{ antecedente.tiempo_exposicion_anos|default:'' }}"
                                    readonly></td>
                            <td><input type="number" value="{{ antecedente.tiempo_exposicion_meses|default:'' }}"
                                    readonly></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td><input type="text" name="nueva_empresa" placeholder="Empresa"></td>
                            <td><input type="text" name="nuevo_cargo" placeholder="Cargo"></td>
                            <td>
                                <select name="nuevo_tipo_proteccion">
                                    <option value="">SELECCIONE</option>
                                    {% for codigo, nombre in tipo_proteccion_choices %}
                                    <option value="{{ codigo }}">{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="nueva_tolerancia">
                                    <option value="">SELECCIONE</option>
                                    {% for codigo, nombre in tolerancia_choices %}
                                    <option value="{{ codigo }}">{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" name="nuevos_anos" placeholder="A√±os"></td>
                            <td><input type="number" name="nuevos_meses" placeholder="Meses"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Antecedentes Familiares y Exposici√≥n Extralaboral -->
                <div class="antecedentes-auditivos-grid">
                    <div class="antecedentes-column">
                        <h6>Antecedentes Familiares</h6>
                        <div class="antecedente-row">
                            <label>OTITIS</label>
                            <input type="text" name="antecedente_OTITIS" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>TRAUMA</label>
                            <input type="text" name="antecedente_TRAUMA" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>CIRUG√çA</label>
                            <input type="text" name="antecedente_CIRUGIA" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>INGESTA OTOT√ìXICOS</label>
                            <input type="text" name="antecedente_INGESTA_OTOTOXICOS" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>HIPOACUSIA SUBJETIVA</label>
                            <input type="text" name="antecedente_HIPOACUSIA_SUBJETIVA" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>AC√öFENOS</label>
                            <input type="text" name="antecedente_ACUFENOS" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>OTROS</label>
                            <input type="text" name="antecedente_OTROS_FAMILIARES" value="">
                        </div>
                    </div>

                    <div class="antecedentes-column">
                        <h6>Exposici√≥n Ruido Extralaboral</h6>
                        <div class="antecedente-row">
                            <label>TEJO</label>
                            <input type="text" name="antecedente_TEJO" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>MOTO</label>
                            <input type="text" name="antecedente_MOTO" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>DISCOTECA</label>
                            <input type="text" name="antecedente_DISCOTECA" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>SERVICIO MILITAR</label>
                            <input type="text" name="antecedente_SERVICIO_MILITAR" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>POL√çGONO</label>
                            <input type="text" name="antecedente_POLIGONO" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>AUD√çFONOS</label>
                            <input type="text" name="antecedente_AUDIFONOS" value="NO REFIERE">
                        </div>
                        <div class="antecedente-row">
                            <label>OTRO</label>
                            <input type="text" name="antecedente_OTROS_EXTRALABORAL" value="">
                        </div>
                    </div>
                </div>

                <!-- Condiciones de toma de la prueba -->
                <div class="prueba-conditions">
                    <h6>Condiciones de toma de la prueba</h6>
                    <div class="conditions-grid">
                        <div class="condition-field">
                            <label>Descanso Auditivo (Horas):</label>
                            <input type="number" name="descanso_auditivo_horas"
                                value="{{ audiometria.descanso_auditivo_horas|default:'' }}" style="width: 80px;">
                        </div>
                        <div class="condition-field">
                            <label>Realiz√≥ re test:</label>
                            <div class="btn-group-toggle">
                                <button type="button"
                                    class="btn-toggle {% if audiometria.realizo_retest %}active{% endif %}"
                                    onclick="toggleRetest(true)">S√≠</button>
                                <button type="button"
                                    class="btn-toggle {% if not audiometria.realizo_retest %}active{% endif %}"
                                    onclick="toggleRetest(false)">No</button>
                            </div>
                            <input type="hidden" name="realizo_retest" id="realizo_retest"
                                value="{{ audiometria.realizo_retest }}">
                        </div>
                        <div class="condition-field">
                            <label>Uso cabina sonoamortiguada:</label>
                            <div class="btn-group-toggle">
                                <button type="button"
                                    class="btn-toggle {% if audiometria.uso_cabina_sonoamortiguada %}active{% endif %}"
                                    onclick="toggleCabina(true)">S√≠</button>
                                <button type="button"
                                    class="btn-toggle {% if not audiometria.uso_cabina_sonoamortiguada %}active{% endif %}"
                                    onclick="toggleCabina(false)">No</button>
                            </div>
                            <input type="hidden" name="uso_cabina_sonoamortiguada" id="uso_cabina_sonoamortiguada"
                                value="{{ audiometria.uso_cabina_sonoamortiguada }}">
                        </div>
                        <div class="condition-field">
                            <label>Marca y referencia audi√≥metro utilizado:</label>
                            <input type="text" name="marca_audiometro"
                                value="{{ audiometria.marca_audiometro|default:'' }}" style="width: 200px;">
                        </div>
                        <div class="condition-field">
                            <label>F. √öltima Calibraci√≥n:</label>
                            <input type="date" name="fecha_ultima_calibracion"
                                value="{{ audiometria.fecha_ultima_calibracion|date:'Y-m-d' }}" style="width: 150px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab de Evaluaci√≥n -->
            <div id="evaluacion" class="tab-content">
                <!-- Convenciones -->
                <div class="conventions-section">
                    <h6>CONVENCIONES</h6>
                    <div class="conventions-grid">
                        <div class="convention-item">
                            <div class="convention-symbol symbol-circle">‚≠ï</div>
                            <span>V√≠a a√©rea del OD (OI enmascarado)</span>
                        </div>
                        <div class="convention-item">
                            <div class="convention-symbol symbol-x">‚úï</div>
                            <span>V√≠a a√©rea del OI (OD enmascarado)</span>
                        </div>
                        <div class="convention-item">
                            <div class="convention-symbol symbol-bracket">[</div>
                            <span>V√≠a √≥sea del OD (sin enmascarar OI)</span>
                        </div>
                        <div class="convention-item">
                            <div class="convention-symbol symbol-arrow">></div>
                            <span>V√≠a √≥sea del OI (sin enmascarar OD)</span>
                        </div>
                        <div class="convention-item">
                            <div class="convention-symbol symbol-square">‚¨ú</div>
                            <span>V√≠a a√©rea del OI con OD enmascarado</span>
                        </div>
                    </div>
                </div>

                <!-- Otoscopia -->
                <div class="otoscopy-section">
                    <div class="otoscopy-field">
                        <h6>OTOSCOPIA - O√≠do Izquierdo</h6>
                        <textarea name="otoscopia_oido_izquierdo"
                            placeholder="Describir hallazgos otosc√≥picos del o√≠do izquierdo">{{ audiometria.otoscopia_oido_izquierdo|default:'' }}</textarea>
                    </div>
                    <div class="otoscopy-field">
                        <h6>OTOSCOPIA - O√≠do Derecho</h6>
                        <textarea name="otoscopia_oido_derecho"
                            placeholder="Describir hallazgos otosc√≥picos del o√≠do derecho">{{ audiometria.otoscopia_oido_derecho|default:'' }}</textarea>
                    </div>
                </div>

                <!-- Tabla de Audiometr√≠a -->
                <h5>Audiometr√≠a</h5>
                <table class="audiometry-table">
                    <thead>
                        <tr>
                            <th>Frecuencia en Hz</th>
                            <th class="frequency-header">250</th>
                            <th class="frequency-header">500</th>
                            <th class="frequency-header">1000</th>
                            <th class="frequency-header">2000</th>
                            <th class="frequency-header">3000</th>
                            <th class="frequency-header">4000</th>
                            <th class="frequency-header">6000</th>
                            <th class="frequency-header">8000</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="test-label">VA OD</td>
                            <td><input type="number" name="va_od_250" value="{{ audiometria.va_od_250|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_500" value="{{ audiometria.va_od_500|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_1000" value="{{ audiometria.va_od_1000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_2000" value="{{ audiometria.va_od_2000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_3000" value="{{ audiometria.va_od_3000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_4000" value="{{ audiometria.va_od_4000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_6000" value="{{ audiometria.va_od_6000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_od_8000" value="{{ audiometria.va_od_8000|default:'' }}"
                                    min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VA OI</td>
                            <td><input type="number" name="va_oi_250" value="{{ audiometria.va_oi_250|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_500" value="{{ audiometria.va_oi_500|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_1000" value="{{ audiometria.va_oi_1000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_2000" value="{{ audiometria.va_oi_2000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_3000" value="{{ audiometria.va_oi_3000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_4000" value="{{ audiometria.va_oi_4000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_6000" value="{{ audiometria.va_oi_6000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_8000" value="{{ audiometria.va_oi_8000|default:'' }}"
                                    min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VO OD</td>
                            <td><input type="number" name="vo_od_250" value="{{ audiometria.vo_od_250|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_500" value="{{ audiometria.vo_od_500|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_1000" value="{{ audiometria.vo_od_1000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_2000" value="{{ audiometria.vo_od_2000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_3000" value="{{ audiometria.vo_od_3000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_4000" value="{{ audiometria.vo_od_4000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_6000" value="{{ audiometria.vo_od_6000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_8000" value="{{ audiometria.vo_od_8000|default:'' }}"
                                    min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VO OI</td>
                            <td><input type="number" name="vo_oi_250" value="{{ audiometria.vo_oi_250|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_500" value="{{ audiometria.vo_oi_500|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_1000" value="{{ audiometria.vo_oi_1000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_2000" value="{{ audiometria.vo_oi_2000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_3000" value="{{ audiometria.vo_oi_3000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_4000" value="{{ audiometria.vo_oi_4000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_6000" value="{{ audiometria.vo_oi_6000|default:'' }}"
                                    min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_8000" value="{{ audiometria.vo_oi_8000|default:'' }}"
                                    min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VA OD CE</td>
                            <td><input type="number" name="va_od_ce_250"
                                    value="{{ audiometria.va_od_ce_250|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_500"
                                    value="{{ audiometria.va_od_ce_500|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_1000"
                                    value="{{ audiometria.va_od_ce_1000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_2000"
                                    value="{{ audiometria.va_od_ce_2000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_3000"
                                    value="{{ audiometria.va_od_ce_3000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_4000"
                                    value="{{ audiometria.va_od_ce_4000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_6000"
                                    value="{{ audiometria.va_od_ce_6000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_od_ce_8000"
                                    value="{{ audiometria.va_od_ce_8000|default:'' }}" min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VA OI CE</td>
                            <td><input type="number" name="va_oi_ce_250"
                                    value="{{ audiometria.va_oi_ce_250|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_500"
                                    value="{{ audiometria.va_oi_ce_500|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_1000"
                                    value="{{ audiometria.va_oi_ce_1000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_2000"
                                    value="{{ audiometria.va_oi_ce_2000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_3000"
                                    value="{{ audiometria.va_oi_ce_3000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_4000"
                                    value="{{ audiometria.va_oi_ce_4000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_6000"
                                    value="{{ audiometria.va_oi_ce_6000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="va_oi_ce_8000"
                                    value="{{ audiometria.va_oi_ce_8000|default:'' }}" min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VO OD CE</td>
                            <td><input type="number" name="vo_od_ce_250"
                                    value="{{ audiometria.vo_od_ce_250|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_500"
                                    value="{{ audiometria.vo_od_ce_500|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_1000"
                                    value="{{ audiometria.vo_od_ce_1000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_2000"
                                    value="{{ audiometria.vo_od_ce_2000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_3000"
                                    value="{{ audiometria.vo_od_ce_3000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_4000"
                                    value="{{ audiometria.vo_od_ce_4000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_6000"
                                    value="{{ audiometria.vo_od_ce_6000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_od_ce_8000"
                                    value="{{ audiometria.vo_od_ce_8000|default:'' }}" min="-10" max="120"></td>
                        </tr>
                        <tr>
                            <td class="test-label">VO OI CE</td>
                            <td><input type="number" name="vo_oi_ce_250"
                                    value="{{ audiometria.vo_oi_ce_250|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_500"
                                    value="{{ audiometria.vo_oi_ce_500|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_1000"
                                    value="{{ audiometria.vo_oi_ce_1000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_2000"
                                    value="{{ audiometria.vo_oi_ce_2000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_3000"
                                    value="{{ audiometria.vo_oi_ce_3000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_4000"
                                    value="{{ audiometria.vo_oi_ce_4000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_6000"
                                    value="{{ audiometria.vo_oi_ce_6000|default:'' }}" min="-10" max="120"></td>
                            <td><input type="number" name="vo_oi_ce_8000"
                                    value="{{ audiometria.vo_oi_ce_8000|default:'' }}" min="-10" max="120"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="text-center my-3">
                    <button type="button" class="btn btn-info" onclick="showAudiogram()">
                        <i class="fas fa-chart-line me-2"></i>Ver Gr√°fico
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateAudiogram()">
                        <i class="fas fa-chart-area me-2"></i>Graficar
                    </button>
                </div>

                <!-- Clasificaci√≥n CAOHC -->
                <h5>Severidad - CAOHC</h5>
                <div class="caohc-severity">
                    <div class="severity-column">
                        <h6>OD</h6>
                        {% for codigo, nombre in severidad_caohc_choices %}
                        <div class="severity-item">
                            <input type="radio" name="severidad_od" id="severity_od_{{ codigo }}" value="{{ codigo }}"
                                {% if audiometria.severidad_od==codigo %}checked{% endif %}>
                            <label for="severity_od_{{ codigo }}">{{ nombre }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="severity-column">
                        <h6>OI</h6>
                        {% for codigo, nombre in severidad_caohc_choices %}
                        <div class="severity-item">
                            <input type="radio" name="severidad_oi" id="severity_oi_{{ codigo }}" value="{{ codigo }}"
                                {% if audiometria.severidad_oi==codigo %}checked{% endif %}>
                            <label for="severity_oi_{{ codigo }}">{{ nombre }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Tab de Recomendaciones -->
            <div id="recomendaciones" class="tab-content">
                <h5>RECOMENDACIONES</h5>
                <div class="recommendations-grid">
                    {% for codigo, nombre in recomendacion_choices %}
                    <div class="recommendation-item">
                        <input type="checkbox" id="rec_{{ codigo }}" name="recomendacion_{{ codigo }}" {% if codigo in
                            recomendaciones_auditivas.all.values_list.codigo %}checked{% endif %}>
                        <label for="rec_{{ codigo }}">{{ nombre }}</label>
                    </div>
                    {% endfor %}
                </div>

                <!-- Observaciones -->
                <div class="info-field">
                    <label>Observaciones:</label>
                    <textarea name="observaciones" rows="4">{{ audiometria.observaciones|default:'' }}</textarea>
                </div>
            </div>
        </div>
    </form>

    <!-- Bot√≥n de guardar -->
    <div class="save-section">
        <button type="submit" form="audiometriaForm" class="btn-save">
            <i class="fas fa-save me-2"></i>Guardar Audiometr√≠a
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showTab(tabName) {
        // Ocultar todos los tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Desactivar todos los headers
        document.querySelectorAll('.tab-header').forEach(header => {
            header.classList.remove('active');
        });

        // Mostrar el tab seleccionado
        document.getElementById(tabName).classList.add('active');

        // Activar el header correspondiente
        event.target.classList.add('active');
    }

    function toggleRetest(value) {
        document.getElementById('realizo_retest').value = value;
        document.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function toggleCabina(value) {
        document.getElementById('uso_cabina_sonoamortiguada').value = value;
        event.target.parentElement.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function showAudiogram() {
        // Implementar visualizaci√≥n del audiograma
        alert('Visualizaci√≥n del audiograma - En desarrollo');
    }

    function generateAudiogram() {
        // Implementar generaci√≥n del audiograma
        alert('Generaci√≥n del audiograma - En desarrollo');
    }

    // Funci√≥n para enviar el formulario
    document.getElementById('audiometriaForm').addEventListener('submit', function (e) {
        e.preventDefault();
        // Implementar guardado AJAX
        alert('Guardando audiometr√≠a... (En desarrollo)');
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Audiometr√≠a cargada correctamente');
    });
</script>
{% endblock %}
