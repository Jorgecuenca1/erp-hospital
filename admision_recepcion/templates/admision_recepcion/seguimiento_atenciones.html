{% extends 'base_hms.html' %}
{% load static %}

{% block title %}Seguimiento a Las Atenciones - Admisión{% endblock %}

{% block extra_css %}
<style>
    .search-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .search-section h5 {
        color: #495057;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .atencion-card {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-bottom: 15px;
        border: none;
        overflow: hidden;
    }

    .atencion-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .atencion-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 15px 15px 0 0;
    }

    .status-en-atencion {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-left: 5px solid #28a745;
    }

    .status-atendido {
        background: linear-gradient(135deg, #cce5ff 0%, #b3d4ff 100%);
        border-left: 5px solid #007bff;
    }

    .status-completado {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        border-left: 5px solid #17a2b8;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    .status-atencion {
        background-color: #28a745;
    }

    .status-atendido {
        background-color: #007bff;
    }

    .status-completado {
        background-color: #17a2b8;
    }

    .servicio-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        margin: 3px;
        display: inline-block;
        border: 1px solid #bbdefb;
    }

    .prestador-info {
        background: #f3e5f5;
        color: #7b1fa2;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 5px;
    }

    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }

    .stats-item {
        text-align: center;
        padding: 15px;
    }

    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }

    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .timeline-mini {
        border-left: 2px solid #e9ecef;
        padding-left: 15px;
        margin-left: 10px;
    }

    .timeline-item {
        margin-bottom: 10px;
        position: relative;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -19px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #28a745;
    }

    .timeline-item.current::before {
        background: #ffc107;
        box-shadow: 0 0 0 2px #ffc107;
        animation: pulse 2s infinite;
    }

    .patient-search {
        position: relative;
    }

    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }

    .suggestion-item:hover {
        background: #f8f9fa;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .filter-chips {
        margin-top: 15px;
    }

    .filter-chip {
        background: #007bff;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        margin: 3px;
        display: inline-block;
    }

    .filter-chip .remove {
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.8;
    }

    .filter-chip .remove:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admision_recepcion:dashboard' %}">Admisión - Recepción</a></li>
        <li class="breadcrumb-item active" aria-current="page">Seguimiento a Las Atenciones</li>
    </ol>
</nav>
{% endblock %}

{% block sidebar %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'admision_recepcion:dashboard' %}">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'admision_recepcion:orden_create' %}">
        <i class="fas fa-plus-circle me-2"></i>Nueva Orden
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'admision_recepcion:orden_list' %}">
        <i class="fas fa-file-medical-alt me-2"></i>Órdenes de Servicios
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'admision_recepcion:seguimiento_pacientes' %}">
        <i class="fas fa-user-check me-2"></i>Seguimiento Pacientes
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{% url 'admision_recepcion:seguimiento_atenciones' %}">
        <i class="fas fa-stethoscope me-2"></i>Seguimiento Atenciones
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">🩺 Seguimiento a Las Atenciones</h1>
            <p class="mb-0 text-muted">de la sección Admisión - Recepción
                <a href="#" class="text-primary ms-2" data-bs-toggle="modal" data-bs-target="#instructionsModal">
                    👉🏼 De clic aquí para aprender o ver los instructivos <i class="fas fa-info-circle"></i>
                </a>
            </p>
        </div>
        <div>
            <button class="btn btn-outline-success me-2" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Exportar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportarExcel()">
                            <i class="fas fa-file-excel text-success me-2"></i>Excel
                        </a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf text-danger me-2"></i>PDF
                        </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sección de Búsqueda -->
    <div class="search-section">
        <h5><i class="fas fa-search me-2"></i>Filtros de Búsqueda</h5>
        <form method="get" id="searchForm">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Fecha:</label>
                    <input type="date" name="fecha" class="form-control"
                        value="{{ filtros_actuales.fecha|default:today }}" id="fechaFilter">
                    <small class="text-muted">11/08/2025</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Buscar Paciente:</label>
                    <div class="patient-search">
                        <input type="text" name="paciente" class="form-control" value="{{ filtros_actuales.paciente }}"
                            placeholder="Nombre, identificación o N° orden..." id="pacienteFilter">
                        <div class="search-suggestions" id="suggestions"></div>
                    </div>
                    <small class="text-muted">Por nombre, identificación o N° de orden</small>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Estado Atención:</label>
                    <select name="estado_atencion" class="form-control" id="estadoFilter">
                        <option value="">Todos</option>
                        <option value="EN_ATENCION" {% if filtros_actuales.estado_atencion == "EN_ATENCION" %}selected{%
                            endif %}>En Atención</option>
                        <option value="ATENDIDO" {% if filtros_actuales.estado_atencion == "ATENDIDO" %}selected{% endif
                            %}>Atendido</option>
                        <option value="COMPLETADO" {% if filtros_actuales.estado_atencion == "COMPLETADO" %}selected{%
                            endif %}>Completado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Sede:</label>
                    <select name="sede" class="form-control" id="sedeFilter">
                        <option value="">Todas</option>
                        <option value="PRINCIPAL" {% if filtros_actuales.sede == "PRINCIPAL" %}selected{% endif %}>
                            Principal</option>
                        <option value="SUCURSAL_1" {% if filtros_actuales.sede == "SUCURSAL_1" %}selected{% endif %}>
                            Sucursal 1</option>
                        <option value="SUCURSAL_2" {% if filtros_actuales.sede == "SUCURSAL_2" %}selected{% endif %}>
                            Sucursal 2</option>
                        <option value="CONSULTORIO_EXTERNO" {% if filtros_actuales.sede=='CONSULTORIO_EXTERNO'
                            %}selected{% endif %}>Consultorio Externo</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </div>

            <!-- Filtros avanzados (colapsible) -->
            <div class="row mt-3">
                <div class="col-md-12">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse"
                        data-bs-target="#filtrosAvanzados">
                        <i class="fas fa-filter me-1"></i>Filtros Avanzados
                    </button>
                </div>
            </div>

            <div class="collapse mt-3" id="filtrosAvanzados">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Prestador/Médico:</label>
                        <select name="prestador" class="form-control">
                            <option value="">Todos los prestadores</option>
                            {% for prestador in prestadores %}
                            <option value="{{ prestador.id }}" {% if
                                filtros_actuales.prestador == prestador.id|stringformat:"s" %}selected{% endif %}>
                                {{ prestador.nombre }} - {{ prestador.especialidad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rango de Fechas:</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" name="fecha_desde" class="form-control" placeholder="Desde">
                            </div>
                            <div class="col-6">
                                <input type="date" name="fecha_hasta" class="form-control" placeholder="Hasta">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <a href="{% url 'admision_recepcion:seguimiento_atenciones' %}"
                            class="btn btn-outline-secondary w-100">
                            <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                        </a>
                    </div>
                </div>
            </div>
        </form>

        <!-- Chips de filtros activos -->
        {% if filtros_actuales.paciente or filtros_actuales.estado_atencion or filtros_actuales.sede or
        filtros_actuales.prestador %}
        <div class="filter-chips">
            <small class="text-muted me-2">Filtros activos:</small>
            {% if filtros_actuales.paciente %}
            <span class="filter-chip">
                Paciente: {{ filtros_actuales.paciente }}
                <span class="remove" onclick="removeFilter('paciente')">&times;</span>
            </span>
            {% endif %}
            {% if filtros_actuales.estado_atencion %}
            <span class="filter-chip">
                Estado: {{ filtros_actuales.estado_atencion }}
                <span class="remove" onclick="removeFilter('estado_atencion')">&times;</span>
            </span>
            {% endif %}
            {% if filtros_actuales.sede %}
            <span class="filter-chip">
                Sede: {{ filtros_actuales.sede }}
                <span class="remove" onclick="removeFilter('sede')">&times;</span>
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Estadísticas -->
    <div class="stats-card">
        <div class="row">
            <div class="col-md-2 stats-item">
                <span class="stats-number text-success">{{ stats.en_atencion }}</span>
                <div class="stats-label">En Atención</div>
            </div>
            <div class="col-md-2 stats-item">
                <span class="stats-number text-primary">{{ stats.atendidos }}</span>
                <div class="stats-label">Atendidos</div>
            </div>
            <div class="col-md-2 stats-item">
                <span class="stats-number text-info">{{ stats.completados }}</span>
                <div class="stats-label">Completados</div>
            </div>
            <div class="col-md-2 stats-item">
                <span class="stats-number text-secondary">{{ stats.total_servicios }}</span>
                <div class="stats-label">Total Servicios</div>
            </div>
            <div class="col-md-2 stats-item">
                <span class="stats-number text-dark">${{ stats.valor_total|floatformat:0 }}</span>
                <div class="stats-label">Valor Total</div>
            </div>
            <div class="col-md-2 stats-item">
                <span class="stats-number text-warning">{{ ordenes.count }}</span>
                <div class="stats-label">Total Atenciones</div>
            </div>
        </div>
    </div>

    <!-- Lista de Atenciones -->
    <div class="row" id="atencionesContainer">
        {% if ordenes %}
        {% for orden in ordenes %}
        <div class="col-lg-6 mb-4">
            <div
                class="atencion-card card {% with ultimo_seguimiento=orden.seguimientos.first %}{% if ultimo_seguimiento.estado == 'EN_ATENCION' %}status-en-atencion{% elif ultimo_seguimiento.estado == 'ATENDIDO' %}status-atendido{% elif orden.estado_orden == 'COMPLETADA' %}status-completado{% endif %}{% endwith %}">
                <div class="atencion-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                {% with ultimo_seguimiento=orden.seguimientos.first %}
                                {% if ultimo_seguimiento.estado == 'EN_ATENCION' %}
                                <span class="status-indicator status-atencion"></span>En Atención
                                {% elif ultimo_seguimiento.estado == 'ATENDIDO' %}
                                <span class="status-indicator status-atendido"></span>Atendido
                                {% elif orden.estado_orden == 'COMPLETADA' %}
                                <span class="status-indicator status-completado"></span>Completado
                                {% endif %}
                                {% endwith %}
                            </h6>
                            <small class="opacity-75">{{ orden.fecha_orden|date:"d/m/Y" }} - {{ orden.get_sede_display
                                }}</small>
                        </div>
                        <div class="text-end">
                            <small class="opacity-75">Orden</small>
                            <div class="fw-bold">{{ orden.numero_orden }}</div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Información del Paciente -->
                    <div class="mb-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-user me-2"></i>{{ orden.nombre_completo }}
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-id-card me-1"></i>{{ orden.get_tipo_documento_display }} {{
                                    orden.numero_identificacion }}
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    <i class="fas fa-building me-1"></i>{{
                                    orden.empresa_mision.razon_social|truncatechars:25 }}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Servicios -->
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <i class="fas fa-stethoscope me-2"></i>Servicios ({{ orden.detalles.count }})
                        </h6>
                        <div class="d-flex flex-wrap">
                            {% for detalle in orden.detalles.all %}
                            <span class="servicio-badge" title="{{ detalle.servicio.descripcion }}">
                                {{ detalle.servicio.nombre|truncatechars:20 }}
                                <span class="prestador-info">{{ detalle.prestador.nombre|truncatechars:15 }}</span>
                            </span>
                            {% endfor %}
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Valor Total:</strong> ${{ orden.total_pagar|floatformat:0 }}
                            </small>
                        </div>
                    </div>

                    <!-- Timeline de Seguimiento -->
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <i class="fas fa-timeline me-2"></i>Historial de Atención
                        </h6>
                        <div class="timeline-mini">
                            {% for seguimiento in orden.seguimientos.all|slice:":3" %}
                            <div class="timeline-item {% if forloop.first %}current{% endif %}">
                                <div class="d-flex justify-content-between">
                                    <small class="fw-bold">{{ seguimiento.get_estado_display }}</small>
                                    <small class="text-muted">{{ seguimiento.fecha_estado|date:"H:i" }}</small>
                                </div>
                                {% if seguimiento.observaciones %}
                                <small class="text-muted d-block">{{ seguimiento.observaciones|truncatechars:50
                                    }}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-outline-success"
                                onclick="cambiarEstadoAtencion({{ orden.id }}, 'EN_ATENCION')" {% with
                                ultimo_seguimiento=orden.seguimientos.first %}{% if
                                ultimo_seguimiento.estado=='EN_ATENCION' %}disabled{% endif %}{% endwith %}>
                                <i class="fas fa-play me-1"></i>Iniciar
                            </button>
                            <button class="btn btn-sm btn-outline-primary"
                                onclick="cambiarEstadoAtencion({{ orden.id }}, 'ATENDIDO')" {% with
                                ultimo_seguimiento=orden.seguimientos.first %}{% if
                                ultimo_seguimiento.estado=='ATENDIDO' %}disabled{% endif %}{% endwith %}>
                                <i class="fas fa-check me-1"></i>Completar
                            </button>
                        </div>
                        <div>
                            <a href="{% url 'admision_recepcion:orden_detail' orden.pk %}"
                                class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye me-1"></i>Ver Detalle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="empty-state">
                <i class="fas fa-stethoscope"></i>
                <h5>No hay atenciones registradas</h5>
                <p>No se encontraron atenciones para los filtros seleccionados.</p>
                <a href="{% url 'admision_recepcion:orden_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Crear Nueva Orden
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Paginación">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Anterior</a>
                </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">{{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                </li>

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link"
                        href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">Última</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Modal de Instrucciones -->
<div class="modal fade" id="instructionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Instrucciones - Seguimiento a Las Atenciones
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="fw-bold mb-3">🎯 Objetivo del Módulo</h6>
                        <p>Este módulo permite hacer seguimiento detallado a todas las atenciones médicas, con búsqueda
                            flexible por día o por paciente específico.</p>

                        <h6 class="fw-bold mb-3">🔍 Opciones de Búsqueda</h6>
                        <ul>
                            <li><strong>Por Día:</strong> Seleccione una fecha para ver todas las atenciones de ese día
                            </li>
                            <li><strong>Por Paciente:</strong> Busque por nombre, número de identificación o número de
                                orden</li>
                            <li><strong>Por Estado:</strong> Filtre por En Atención, Atendido o Completado</li>
                            <li><strong>Por Sede:</strong> Vea atenciones de una sede específica</li>
                            <li><strong>Por Prestador:</strong> Filtre por médico o prestador de servicio</li>
                        </ul>

                        <h6 class="fw-bold mb-3">📊 Estados de Atención</h6>
                        <div class="d-flex flex-column gap-2">
                            <div><span class="status-indicator status-atencion"></span> <strong>Verde:</strong> Paciente
                                en atención activa</div>
                            <div><span class="status-indicator status-atendido"></span> <strong>Azul:</strong> Paciente
                                atendido</div>
                            <div><span class="status-indicator status-completado"></span> <strong>Celeste:</strong>
                                Atención completada</div>
                        </div>

                        <h6 class="fw-bold mb-3 mt-3">🚀 Funcionalidades</h6>
                        <ul>
                            <li>Ver historial completo de atención de cada paciente</li>
                            <li>Cambiar estados de atención en tiempo real</li>
                            <li>Acceder a detalles completos de cada orden</li>
                            <li>Exportar reportes en Excel o PDF</li>
                            <li>Filtros avanzados combinables</li>
                        </ul>

                        <h6 class="fw-bold mb-3">📱 Uso Rápido</h6>
                        <ol>
                            <li>Use la fecha para ver atenciones del día</li>
                            <li>Escriba el nombre del paciente para búsqueda específica</li>
                            <li>Use los botones "Iniciar" y "Completar" para cambiar estados</li>
                            <li>Haga clic en "Ver Detalle" para información completa</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Auto-búsqueda de pacientes
        let searchTimeout;
        $('#pacienteFilter').on('input', function () {
            clearTimeout(searchTimeout);
            const term = $(this).val();

            if (term.length >= 2) {
                searchTimeout = setTimeout(function () {
                    buscarPacientes(term);
                }, 300);
            } else {
                $('#suggestions').hide();
            }
        });

        // Buscar pacientes para sugerencias
        function buscarPacientes(term) {
            // Simulación de búsqueda (en producción sería AJAX)
            const sugerencias = [
                'Juan Carlos García López - CC 12345678',
                'María Rodríguez Vargas - CC 23456789',
                'Carlos Mendoza Silva - CC 34567890',
                'OS202508100001 - Juan García',
                'OS202508100002 - María Rodríguez'
            ].filter(item => item.toLowerCase().includes(term.toLowerCase()));

            mostrarSugerencias(sugerencias);
        }

        function mostrarSugerencias(sugerencias) {
            const container = $('#suggestions');
            container.empty();

            if (sugerencias.length > 0) {
                sugerencias.forEach(function (sugerencia) {
                    const item = $('<div class="suggestion-item"></div>').text(sugerencia);
                    item.click(function () {
                        $('#pacienteFilter').val(sugerencia.split(' - ')[0]);
                        container.hide();
                        $('#searchForm').submit();
                    });
                    container.append(item);
                });
                container.show();
            } else {
                container.hide();
            }
        }

        // Ocultar sugerencias al hacer clic fuera
        $(document).click(function (e) {
            if (!$(e.target).closest('.patient-search').length) {
                $('#suggestions').hide();
            }
        });

        // Auto-submit del formulario
        $('#fechaFilter, #estadoFilter, #sedeFilter').change(function () {
            $('#searchForm').submit();
        });

        // Actualizar datos
        $('#refreshBtn').click(function () {
            window.location.reload();
        });
    });

    // Cambiar estado de atención
    function cambiarEstadoAtencion(ordenId, nuevoEstado) {
        if (confirm('¿Está seguro de cambiar el estado de la atención?')) {
            $.post(`/admision/ajax/seguimiento/${ordenId}/`, {
                'estado': nuevoEstado,
                'observaciones': `Estado cambiado a ${nuevoEstado} desde seguimiento de atenciones`,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            }, function (response) {
                if (response.success) {
                    // Recargar la página para mostrar los cambios
                    window.location.reload();
                    showToast('Estado actualizado correctamente', 'success');
                } else {
                    showToast('Error al actualizar estado', 'error');
                }
            }).fail(function () {
                showToast('Error de conexión', 'error');
            });
        }
    }

    // Remover filtro específico
    function removeFilter(filterName) {
        const url = new URL(window.location);
        url.searchParams.delete(filterName);
        window.location.href = url.toString();
    }

    // Exportar datos
    function exportarExcel() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'excel');
        window.open(`${window.location.pathname}?${params.toString()}`);
    }

    function exportarPDF() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'pdf');
        window.open(`${window.location.pathname}?${params.toString()}`);
    }

    // Mostrar notificaciones toast
    function showToast(message, type) {
        // Implementación de notificaciones toast
        const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);

        // Agregar contenedor de toasts si no existe
        if (!$('.toast-container').length) {
            $('body').append('<div class="toast-container position-fixed top-0 end-0 p-3"></div>');
        }

        $('.toast-container').append(toast);
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();

        // Remover toast después de ocultarlo
        toast.on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }
</script>
{% endblock %}
